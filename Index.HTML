<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>6-Month MCD Credit Risk Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <!-- Chosen Palette: Warm Neutral (Stone/Amber) with Report-Specific Accents (Red, Amber, Green, Blue) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
            max-height: 400px;
        }
        .chart-container-horizontal {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 300px;
        }
        @media (max-width: 768px) {
            .chart-container {
                height: 350px;
                max-height: 350px;
            }
            .chart-container-horizontal {
                height: 250px;
                max-height: 250px;
            }
        }
        .nav-button {
            transition: all 0.3s ease;
            white-space: nowrap; 
        }
        .nav-button.active {
            border-bottom-color: #f59e0b; 
            color: #f59e0b;
        }
        .data-table th, .data-table td {
            padding: 0.75rem 1.5rem;
        }
        .data-table th {
            font-weight: 600;
        }
        .data-table tbody tr:hover {
            background-color: #f5f5f4;
        }
        /* Sparkline container for table cells */
        .sparkline-cell {
            width: 100px; /* Fixed width for consistent visual comparison */
            height: 40px;
            padding: 0;
            position: relative;
        }
        .llm-output-box {
            min-height: 100px;
            border: 1px solid #e7e5e4;
            padding: 1rem;
            background-color: #fafaf9;
        }
    </style>
</head>
<body class="bg-stone-50 text-stone-900">

    <div class="min-h-screen">
        
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
                <h1 class="text-3xl font-bold tracking-tight text-stone-800">Trailing 6-Month MCD Credit Risk Dashboard</h1>
                <p id="header-date-range" class="mt-1 text-base text-stone-600">Waiting for data...</p>
            </div>
        </header>

        <nav class="bg-white shadow-md sticky top-0 z-10 overflow-x-auto">
            <div id="nav-container" class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex space-x-2 sm:space-x-4">
                <!-- Navigation buttons generated by JS -->
            </div>
        </nav>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div id="content-container">
                <!-- Page content generated by JS -->
            </div>
        </main>
    </div>

    <script>
        // Placeholder for data array, filled after CSV upload
        let ALL_MCD_DATA = [];

        let sentimentChartInstance = null;
        let nonCreditChartInstance = null;
        
        // --- 1. UTILITY FUNCTIONS ---

        function formatCurrency(amount) {
            if (amount === null || amount === undefined || isNaN(amount)) {
                return '$0.00';
            }
            return `$${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        function formatNumber(amount) {
             if (amount === null || amount === undefined || isNaN(amount)) {
                return '0';
            }
            return amount.toLocaleString('en-US');
        }
        
        function updateHeaderDates() {
            const headerDateElement = document.getElementById('header-date-range');
            if (ALL_MCD_DATA.length >= 2) {
                const firstMonth = ALL_MCD_DATA[0].month_label;
                const lastMonth = ALL_MCD_DATA[ALL_MCD_DATA.length - 1].month_label;
                headerDateElement.textContent = `${firstMonth} - ${lastMonth} Analysis Focused on 'HubSpot Credits'.`;
            } else if (ALL_MCD_DATA.length === 1) {
                headerDateElement.textContent = `${ALL_MCD_DATA[0].month_label} Analysis Focused on 'HubSpot Credits'.`;
            } else {
                headerDateElement.textContent = 'Waiting for data...';
            }
        }

        function createNavButtons() {
            const navContainer = document.getElementById('nav-container');
            navContainer.innerHTML = '';
            
            // Only create navigation buttons if data is present
            if (ALL_MCD_DATA.length === 0) {
                return; 
            }

            // 1. Summary Button (Always first)
            navContainer.innerHTML += `
                <button data-tab="summary" class="nav-button text-stone-700 hover:text-amber-600 py-4 px-3 text-sm font-medium border-b-2 border-transparent">
                    6-Month Summary
                </button>
            `;

            // 2. Monthly Detail Buttons (oldest to newest)
            ALL_MCD_DATA.forEach(data => {
                navContainer.innerHTML += `
                    <button data-tab="${data.date_id}" class="nav-button text-stone-700 hover:text-amber-600 py-4 px-3 text-sm font-medium border-b-2 border-transparent">
                        ${data.month_label.split(' ')[0]}
                    </button>
                `;
            });
            
            // 3. Index Button (LAST: after all months)
            navContainer.innerHTML += `
                <button data-tab="index" class="nav-button text-stone-700 hover:text-amber-600 py-4 px-3 text-sm font-medium border-b-2 border-transparent">
                    Index / Assumptions
                </button>
            `;

            setupNavigation();
        }
        
        // --- 2. TEMPLATE GENERATION FUNCTIONS ---

        function getIndexTemplate() {
            return `
                <div id="index" class="page-content hidden space-y-8">
                    <h2 class="text-3xl font-bold text-stone-800 mb-6">Dashboard Index & Assumptions</h2>
                    <p class="text-lg text-stone-700 leading-relaxed border-b pb-4 mb-4 border-stone-200">
                        This index provides the definitive source for all calculation logic, column requirements, tag definitions, and assumptions used throughout the dashboard.
                    </p>

                    <!-- SECTION 1: DATA PREPARATION & REQUIREMENTS -->
                    <section class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                        <h3 class="text-2xl font-semibold text-amber-700 mb-4">1. Data Preparation & Requirements</h3>
                        <div class="space-y-4 text-stone-700">
                            <div>
                                <h4 class="font-bold text-stone-800">1.1. Required CSV Columns</h4>
                                <p class="text-sm mb-2">The dashboard requires <strong>five</strong> critical column headers in the uploaded CSV file. Headers are matched robustly (case-insensitive, trim-friendly):</p>
                                <ul class="list-disc list-inside ml-4 text-sm font-mono mt-2 space-y-1">
                                    <li><code>Interaction Month</code> - Date field used for grouping data by month</li>
                                    <li><code>Portal ID</code> - Unique identifier for each customer portal</li>
                                    <li><code>MCD Tags</code> - Comma-separated list of tags categorizing the MCD</li>
                                    <li><code>Total Net MRR BOM</code> - Monthly Recurring Revenue at beginning of month</li>
                                    <li><code>Total Net MRR EOM</code> - Monthly Recurring Revenue at end of month</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-bold text-stone-800">1.2. Data Processing Assumptions</h4>
                                <ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">
                                    <li><strong>Date Parsing:</strong> The <code>Interaction Month</code> field is parsed to extract the first 7 characters (YYYY-MM format). Dates are processed using UTC timezone to prevent local timezone shifts.</li>
                                    <li><strong>Portal ID Normalization:</strong> Portal IDs are cleaned by removing trailing ".0" suffixes (e.g., "12345.0" becomes "12345").</li>
                                    <li><strong>MRR Value Cleaning:</strong> MRR values are cleaned by removing spaces, dollar signs, and commas before parsing. Invalid or missing values default to 0.</li>
                                    <li><strong>Data Filtering:</strong> Rows with empty <code>MCD Tags</code> are excluded from all calculations.</li>
                                    <li><strong>Month Sorting:</strong> Data is sorted chronologically by month (YYYY-MM) before processing.</li>
                                    <li><strong>Data Retention:</strong> Only the most recent 6 months of data are retained for analysis.</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION 2: TAG DEFINITIONS & NORMALIZATION -->
                    <section class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                        <h3 class="text-2xl font-semibold text-amber-700 mb-4">2. Tag Definitions & Normalization Logic</h3>
                        <div class="space-y-4 text-stone-700">
                            <div>
                                <h4 class="font-bold text-stone-800">2.1. Tag Processing</h4>
                                <ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">
                                    <li><strong>Delimiter:</strong> Tags within the <code>MCD Tags</code> column are separated by commas (<code>,</code>).</li>
                                    <li><strong>Normalization:</strong> All tags are automatically converted to <strong>lowercase</strong> and <strong>trimmed</strong> of whitespace during processing to ensure accurate matching.</li>
                                    <li><strong>Empty Tag Filtering:</strong> Empty tags (after trimming) are filtered out and not included in any calculations.</li>
                                    <li><strong>CSV Parsing:</strong> The CSV parser handles quoted fields containing commas, ensuring tags within quotes are preserved correctly.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-bold text-stone-800">2.2. Core Tag Definitions</h4>
                                <p class="text-sm mb-2">The following tags are used throughout the dashboard for filtering and categorization. All tag matching is case-insensitive after normalization:</p>
                                
                                <div class="mt-3 space-y-3">
                                    <div class="border-l-4 border-amber-600 pl-3">
                                        <h5 class="font-semibold text-stone-800">Primary Scope Tag</h5>
                                        <ul class="list-disc list-inside ml-4 text-sm space-y-1 mt-1">
                                            <li><code>hubspot credits</code> - <strong>Primary filter tag.</strong> All calculated metrics are first filtered to records containing this tag. This is the core scope for credit-related analysis.</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="border-l-4 border-red-600 pl-3">
                                        <h5 class="font-semibold text-stone-800">Explicit Refund Tags</h5>
                                        <p class="text-sm mt-1 mb-1">Any of these tags trigger the Explicit Refund Request count:</p>
                                        <ul class="list-disc list-inside ml-4 text-sm font-mono space-y-1">
                                            <li><code>refund</code></li>
                                            <li><code>refund/credit indicators</code></li>
                                            <li><code>refund/credit request</code></li>
                                        </ul>
                                    </div>
                                    
                                    <div class="border-l-4 border-amber-600 pl-3">
                                        <h5 class="font-semibold text-stone-800">Primary Friction Tags</h5>
                                        <ul class="list-disc list-inside ml-4 text-sm space-y-1 mt-1">
                                            <li><code>financial constraints</code> - Measures customer concerns over pricing/cost (Pricing Model Concerns)</li>
                                            <li><code>accidental purchase/upgrade</code> - Measures customer friction due to accidental oversizing or UI confusion (Accidental Overage Friction)</li>
                                        </ul>
                                    </div>
                                    
                                    <div class="border-l-4 border-green-600 pl-3">
                                        <h5 class="font-semibold text-stone-800">Secondary Action Tags</h5>
                                        <ul class="list-disc list-inside ml-4 text-sm space-y-1 mt-1">
                                            <li><code>seat change</code> - Measures primary customer action in response to friction (Seat Contraction)</li>
                                            <li><code>contact downgrade</code> - Measures secondary customer action in response to friction (Contact Contraction)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-stone-800">2.3. Non-Credit Tag Filtering</h4>
                                <p class="text-sm">For the "Top Non-Credit MCD Categories" metric, records are filtered to exclude <strong>all</strong> records containing <strong>any</strong> of the following tags:</p>
                                <ul class="list-disc list-inside ml-4 text-sm font-mono mt-2 space-y-1">
                                    <li><code>hubspot credits</code></li>
                                    <li><code>refund</code>, <code>refund/credit indicators</code>, <code>refund/credit request</code></li>
                                    <li><code>financial constraints</code></li>
                                    <li><code>accidental purchase/upgrade</code></li>
                                    <li><code>seat change</code></li>
                                    <li><code>contact downgrade</code></li>
                                </ul>
                                <p class="text-sm mt-2">The remaining tags are counted, sorted by frequency (descending), and the top 3 categories are displayed as the baseline.</p>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION 3: CALCULATION LOGIC -->
                    <section class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                        <h3 class="text-2xl font-semibold text-amber-700 mb-4">3. Metric Calculation Logic</h3>
                        <div class="space-y-6 text-stone-700">
                            <div>
                                <h4 class="font-bold text-stone-800">3.1. Core Credit Volume Metrics</h4>
                                <ul class="list-disc list-inside ml-4 space-y-3 text-sm">
                                    <li>
                                        <strong>Total MCDs (Credit-Related):</strong> Count of all records containing the <code>hubspot credits</code> tag.
                                        <br><span class="text-stone-500 italic">Formula: Count(records where tags includes 'hubspot credits')</span>
                                    </li>
                                    <li>
                                        <strong>Total MCDs (Credit-Related) Percentage:</strong> Percentage of credit-related MCDs out of all MCDs.
                                        <br><span class="text-stone-500 italic">Formula: (Total Credit MCDs / Total All MCDs) × 100, rounded to 1 decimal place</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-stone-800 pt-3 border-t">3.2. Financial Risk Metrics</h4>
                                <ul class="list-disc list-inside ml-4 space-y-3 text-sm">
                                    <li>
                                        <strong>Estimated Refund Risk (MRR Exposed):</strong> Sum of all positive MRR changes (contraction) where a <code>hubspot credits</code> MCD was involved.
                                        <br><span class="text-stone-500 italic">Formula: Sum(MRR_BOM - MRR_EOM) for all records where (MRR_BOM > MRR_EOM) AND (tags includes 'hubspot credits')</span>
                                        <br><span class="text-stone-500 italic">Note: Only positive MRR changes (contractions) are included, representing potential refund exposure.</span>
                                    </li>
                                    <li>
                                        <strong>Explicit Refund Requests (Count):</strong> Two-step filter: must be a <code>hubspot credits</code> MCD <strong>AND</strong> must contain at least one of the three Explicit Refund Tags.
                                        <br><span class="text-stone-500 italic">Formula: Count(Credit MCDs ∩ Explicit Refund Tags)</span>
                                    </li>
                                    <li>
                                        <strong>Explicit Refund Requests (Percentage):</strong> Percentage of credit-related MCDs that contain explicit refund tags.
                                        <br><span class="text-stone-500 italic">Formula: (Explicit Refund Count / Total Credit MCDs) × 100, rounded to 1 decimal place</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-stone-800 pt-3 border-t">3.3. Primary Friction Metrics</h4>
                                <ul class="list-disc list-inside ml-4 space-y-3 text-sm">
                                    <li>
                                        <strong>Pricing Model Concerns (Count):</strong> Count of <code>hubspot credits</code> MCDs that also contain the <code>financial constraints</code> tag.
                                        <br><span class="text-stone-500 italic">Formula: Count(Credit MCDs where tags includes 'financial constraints')</span>
                                    </li>
                                    <li>
                                        <strong>Pricing Model Concerns (Percentage):</strong> Percentage of credit-related MCDs with pricing concerns.
                                        <br><span class="text-stone-500 italic">Formula: (Pricing Count / Total Credit MCDs) × 100, rounded to 1 decimal place</span>
                                    </li>
                                    <li>
                                        <strong>Accidental Overage Friction (Count):</strong> Count of <code>hubspot credits</code> MCDs that also contain the <code>accidental purchase/upgrade</code> tag.
                                        <br><span class="text-stone-500 italic">Formula: Count(Credit MCDs where tags includes 'accidental purchase/upgrade')</span>
                                    </li>
                                    <li>
                                        <strong>Accidental Overage Friction (Percentage):</strong> Percentage of credit-related MCDs with accidental overage friction.
                                        <br><span class="text-stone-500 italic">Formula: (Accidental Count / Total Credit MCDs) × 100, rounded to 1 decimal place</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-stone-800 pt-3 border-t">3.4. Secondary Action Metrics</h4>
                                <ul class="list-disc list-inside ml-4 space-y-3 text-sm">
                                    <li>
                                        <strong>Seat Change (Count):</strong> Count of <code>hubspot credits</code> MCDs that also contain the <code>seat change</code> tag.
                                        <br><span class="text-stone-500 italic">Formula: Count(Credit MCDs where tags includes 'seat change')</span>
                                    </li>
                                    <li>
                                        <strong>Seat Change (Percentage):</strong> Percentage of credit-related MCDs with seat changes.
                                        <br><span class="text-stone-500 italic">Formula: (Seat Change Count / Total Credit MCDs) × 100, rounded to 1 decimal place</span>
                                    </li>
                                    <li>
                                        <strong>Contact Downgrade (Count):</strong> Count of <code>hubspot credits</code> MCDs that also contain the <code>contact downgrade</code> tag.
                                        <br><span class="text-stone-500 italic">Formula: Count(Credit MCDs where tags includes 'contact downgrade')</span>
                                    </li>
                                    <li>
                                        <strong>Contact Downgrade (Percentage):</strong> Percentage of credit-related MCDs with contact downgrades.
                                        <br><span class="text-stone-500 italic">Formula: (Contact Downgrade Count / Total Credit MCDs) × 100, rounded to 1 decimal place</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-stone-800 pt-3 border-t">3.5. Non-Credit Baseline Metrics</h4>
                                <ul class="list-disc list-inside ml-4 space-y-3 text-sm">
                                    <li>
                                        <strong>Top Non-Credit MCD Categories:</strong> Calculated by filtering out all records containing any of the defined credit, pricing, refund, seat, or contact tags. The remaining tags are counted, sorted by frequency (descending), and the top 3 are displayed.
                                        <br><span class="text-stone-500 italic">Formula: Filter(all MCDs excluding credit-related tags) → Count tags → Sort by frequency → Select top 3</span>
                                    </li>
                                    <li>
                                        <strong>Non-Credit Category Percentage:</strong> For each top category, percentage is calculated relative to total non-credit MCDs.
                                        <br><span class="text-stone-500 italic">Formula: (Category Count / Total Non-Credit MCDs) × 100, rounded to 1 decimal place</span>
                                    </li>
                                </ul>
                            </div>
                            
                            <div>
                                <h4 class="font-bold text-stone-800 pt-3 border-t">3.6. Portal Activity Metrics</h4>
                                <ul class="list-disc list-inside ml-4 space-y-3 text-sm">
                                    <li>
                                        <strong>Total Unique Portals (All MCDs):</strong> Count of distinct Portal IDs across all MCD records for the month.
                                        <br><span class="text-stone-500 italic">Formula: Count(Distinct Portal IDs)</span>
                                    </li>
                                    <li>
                                        <strong>Portals with Credit MCDs:</strong> Count of distinct Portal IDs that have at least one credit-related MCD.
                                        <br><span class="text-stone-500 italic">Formula: Count(Distinct Portal IDs where tags includes 'hubspot credits')</span>
                                    </li>
                                    <li>
                                        <strong>Portals with Multiple MCDs:</strong> Count of Portal IDs that appear in more than one MCD record for the month.
                                        <br><span class="text-stone-500 italic">Formula: Count(Portal IDs where MCD count > 1)</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION 4: DATA PROCESSING ASSUMPTIONS -->
                    <section class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                        <h3 class="text-2xl font-semibold text-amber-700 mb-4">4. Data Processing Assumptions</h3>
                        <div class="space-y-4 text-stone-700">
                            <div>
                                <h4 class="font-bold text-stone-800">4.1. MRR Calculation Assumptions</h4>
                                <ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">
                                    <li><strong>MRR Change Calculation:</strong> MRR Change = MRR_BOM - MRR_EOM. Positive values indicate contraction (revenue loss), negative values indicate expansion (revenue gain).</li>
                                    <li><strong>Refund Risk Calculation:</strong> Only positive MRR changes (contractions) from credit-related MCDs are included in the Estimated Refund Risk calculation.</li>
                                    <li><strong>Value Cleaning:</strong> MRR values are cleaned by removing spaces, dollar signs ($), and commas before parsing. Invalid values default to 0.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-bold text-stone-800">4.2. Date & Time Handling</h4>
                                <ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">
                                    <li><strong>Month Extraction:</strong> The <code>Interaction Month</code> field is truncated to the first 7 characters (YYYY-MM format).</li>
                                    <li><strong>UTC Timezone:</strong> All date parsing uses UTC timezone to prevent local timezone shifts that could affect month grouping.</li>
                                    <li><strong>Month Labeling:</strong> Month labels are generated using UTC methods for consistency (e.g., "January 2024").</li>
                                    <li><strong>Date ID Generation:</strong> Date IDs are generated as lowercase month abbreviations with year (e.g., "jan-2024").</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-bold text-stone-800">4.3. Percentage Calculation Assumptions</h4>
                                <ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">
                                    <li><strong>Rounding:</strong> All percentages are rounded to 1 decimal place using <code>toFixed(1)</code>.</li>
                                    <li><strong>Division by Zero:</strong> If the denominator is 0, percentages default to 0 (not NaN or undefined).</li>
                                    <li><strong>Percentage Base:</strong> All credit-related percentages use "Total Credit MCDs" as the denominator, except "Total MCDs (Credit-Related) Percentage" which uses "Total All MCDs".</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-bold text-stone-800">4.4. Data Filtering & Grouping</h4>
                                <ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">
                                    <li><strong>Month Grouping:</strong> All calculations are performed per month, with data grouped by the extracted YYYY-MM value.</li>
                                    <li><strong>Chronological Sorting:</strong> Months are sorted chronologically (ascending) before processing and display.</li>
                                    <li><strong>Data Retention:</strong> Only the most recent 6 months of data are retained after sorting.</li>
                                    <li><strong>Empty Tag Filtering:</strong> Rows with empty or whitespace-only <code>MCD Tags</code> are excluded from all calculations.</li>
                                </ul>
                            </div>
                        </div>
                    </section>

                    <!-- SECTION 5: DISPLAY & VISUALIZATION ASSUMPTIONS -->
                    <section class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                        <h3 class="text-2xl font-semibold text-amber-700 mb-4">5. Display & Visualization Assumptions</h3>
                        <div class="space-y-4 text-stone-700">
                            <div>
                                <h4 class="font-bold text-stone-800">5.1. Summary Table Display</h4>
                                <ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">
                                    <li><strong>Trend Sparklines:</strong> The 6-month trend column displays sparkline charts showing the metric's progression over time.</li>
                                    <li><strong>Sparkline Scaling:</strong> Sparklines are auto-scaled to fit the data range (min: 95% of data minimum, max: 105% of data maximum).</li>
                                    <li><strong>Color Coding:</strong> Sparklines use different colors based on metric type: red for currency/risk metrics, amber for percentages, blue for counts.</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-bold text-stone-800">5.2. Key Takeaways Generation</h4>
                                <ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">
                                    <li><strong>Comparison Period:</strong> Key takeaways compare the most recent month to the prior month (requires at least 2 months of data).</li>
                                    <li><strong>Directional Language:</strong> Metrics are described as "increased", "decreased", "improved", "worsened", or "remained stable" based on the change direction.</li>
                                    <li><strong>Percentage Point Changes:</strong> For percentage metrics, changes are described in "percentage points" (e.g., "moved by 2.5 percentage points").</li>
                                </ul>
                            </div>
                            <div>
                                <h4 class="font-bold text-stone-800">5.3. Chart Display Assumptions</h4>
                                <ul class="list-disc list-inside ml-4 text-sm space-y-2 mt-2">
                                    <li><strong>Sentiment Chart:</strong> Displays percentages for Pricing, Seat Change, Contact Downgrade, and Accidental Overage, with a maximum Y-axis of 40%.</li>
                                    <li><strong>Non-Credit Chart:</strong> Displays horizontal bar chart showing the top 3 non-credit categories by count.</li>
                                    <li><strong>Chart Responsiveness:</strong> Charts are responsive and adjust to container size, with mobile-specific height adjustments.</li>
                                </ul>
                            </div>
                        </div>
                    </section>
                </div>
            `;
        }

        function generateKeyTakeaways(data) {
            if (data.length < 2) return '';

            const current = data[data.length - 1]; // Latest month
            const prior = data[data.length - 2]; // Prior month
            
            const takeaways = [];
            const isIncrease = (currentVal, priorVal) => currentVal > priorVal;
            
            // 1. Total MCD Volume (Count)
            const volumeDirection = isIncrease(current.total_mcds_credit, prior.total_mcds_credit) ? 'increased' : 'decreased';
            takeaways.push(`**Total Credit-Related MCD volume ${volumeDirection}** from ${formatNumber(prior.total_mcds_credit)} to ${formatNumber(current.total_mcds_credit)}.`);

            // 2. Refund Risk (MRR)
            const riskDirection = isIncrease(current.risk_refund_amount, prior.risk_refund_amount) ? 'increased' : 'decreased';
            takeaways.push(`**Estimated Refund Risk (MRR)** ${riskDirection} substantially, moving from ${formatCurrency(prior.risk_refund_amount)} to ${formatCurrency(current.risk_refund_amount)}.`);

            // 3. Accidental Overage Rate (Friction)
            const accidentalRateChange = current.accidental_perc - prior.accidental_perc;
            const accidentalTrend = accidentalRateChange < 0 ? 'improved' : (accidentalRateChange > 0 ? 'worsened' : 'remained stable');
            const accidentalDirection = Math.abs(accidentalRateChange).toFixed(1);
            takeaways.push(`**Accidental Overage Friction** ${accidentalTrend}, moving by ${accidentalDirection} percentage points (from ${prior.accidental_perc}% to ${current.accidental_perc}%).`);

            // 4. Pricing Concerns Rate (Sentiment)
            const pricingRateChange = current.pricing_perc - prior.pricing_perc;
            const pricingTrend = pricingRateChange > 0 ? 'worsened' : (pricingRateChange < 0 ? 'improved' : 'remained stable');
            const pricingDirection = Math.abs(pricingRateChange).toFixed(1);
            takeaways.push(`**Pricing Model Concerns (Financial Constraints)** ${pricingTrend}, moving by ${pricingDirection} percentage points (from ${prior.pricing_perc}% to ${current.pricing_perc}%).`);
            
            // 5. Seat Contraction (Action)
            const seatDirection = isIncrease(current.seat_change_count, prior.seat_change_count) ? 'increased' : 'decreased';
            takeaways.push(`**Secondary Action (Seat Contraction)** ${seatDirection} in volume, from ${formatNumber(prior.seat_change_count)} to ${formatNumber(current.seat_change_count)}. `);


            let html = `
                <section class="mb-8">
                    <h2 class="text-2xl font-semibold text-stone-800 mb-4">Key Takeaways: ${current.month_label} vs. ${prior.month_label}</h2>
                    <ul class="list-disc list-inside space-y-3 pl-4 text-lg text-stone-700 leading-relaxed bg-white p-6 rounded-lg shadow-md border border-stone-200">
                        ${takeaways.map(t => `<li class="pl-2">${t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')}</li>`).join('')}
                    </ul>
                </section>
            `;
            return html;
        }

        function getSummaryTemplate(data) {
            // Get dynamic date range for header and title
            let dateRangeTitle = '6-Month Trailing Summary';
            let keyTakeawaysHtml = '';

            if (data.length >= 2) {
                const firstMonth = data[0].month_label;
                const lastMonth = data[data.length - 1].month_label;
                dateRangeTitle = `${data.length}-Month Trailing Summary (${firstMonth} - ${lastMonth})`;
                keyTakeawaysHtml = generateKeyTakeaways(data);
            }

            return `
                <div id="summary" class="page-content hidden space-y-8">
                    <h2 class="text-3xl font-bold text-stone-800 mb-4">${dateRangeTitle}</h2>
                    
                    <section class="bg-white p-6 rounded-lg shadow-md border border-stone-200 mb-8">
                        <h3 class="text-xl font-semibold text-amber-700 mb-3">Data Upload & Refresh</h3>
                        <p class="text-base text-stone-700 mb-4">
                            To update the dashboard, please upload a combined CSV file containing the 6 months of data, including: <code>Interaction Month</code>, <code>Portal ID</code>, <code>MCD Tags</code>, <code>Total Net MRR BOM</code>, and <code>Total Net MRR EOM</code>.
                            <br>
                            <span class="text-sm text-stone-500">For all data definitions and assumptions, please refer to the <strong>Index / Assumptions</strong> tab.</span>
                        </p>
                        <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4">
                            <input type="file" id="csv-file-input" accept=".csv" class="w-full sm:w-auto text-sm text-stone-500
                                file:mr-4 file:py-2 file:px-4
                                file:rounded-full file:border-0
                                file:text-sm file:font-semibold
                                file:bg-stone-100 file:text-amber-700
                                hover:file:bg-stone-200"/>
                            <button id="refresh-dashboard" class="w-full sm:w-auto bg-amber-600 hover:bg-amber-700 text-white font-bold py-2 px-6 rounded-full shadow-md transition duration-150" disabled>
                                Process & Refresh Dashboard
                            </button>
                        </div>
                           <p id="upload-status" class="mt-3 text-sm text-red-500 h-4"></p>
                    </section>
                    
                    
                    ${data.length >= 2 ? keyTakeawaysHtml : ''}
                    
                    ${data.length > 0 ? `
                        
                        <div class="bg-white p-6 rounded-lg shadow-md border border-stone-200 overflow-x-auto">
                            <h3 class="text-xl font-semibold text-stone-800 mb-4">Key Credit Risk Metrics</h3>
                            <table class="min-w-full divide-y divide-stone-200 data-table">
                                <thead class="bg-stone-50">
                                    <tr>
                                        <th scope="col" class="text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Metric / Theme</th>
                                        ${data.map(d => `<th scope="col" class="text-left text-xs font-medium text-stone-500 uppercase tracking-wider">${d.month_label.split(' ')[0]}</th>`).join('')}
                                        <th scope="col" class="text-center text-xs font-medium text-stone-500 uppercase tracking-wider bg-stone-100">6 MONTH TREND</th>
                                    </tr>
                                </thead>
                                <tbody id="summary-tbody" class="bg-white divide-y divide-stone-200">
                                    <!-- Data rows injected by JS -->
                                </tbody>
                            </table>
                        </div>
                    ` : `<p class="text-xl text-center text-stone-600 mt-10">Waiting for data... Please upload a combined CSV file using the section above to load the dashboard.</p>`}
                </div>
            `;
        }

        function getMonthlyDetailTemplate(data) {
            const totalMCDsCreditSafe = data.total_mcds_credit !== undefined && data.total_mcds_credit !== null ? data.total_mcds_credit.toLocaleString() : 'N/A';
            const accidentalCountSafe = data.accidental_count !== undefined && data.accidental_count !== null ? data.accidental_count.toLocaleString() : 'N/A';
            const portalsCreditSafe = data.portals_with_credit_mcds !== undefined && data.portals_with_credit_mcds !== null ? data.portals_with_credit_mcds.toLocaleString() : 'N/A';
            const uniquePortalsAllSafe = data.unique_portals_all !== undefined && data.unique_portals_all !== null ? data.unique_portals_all.toLocaleString() : 'N/A';
            const portalsMultipleSafe = data.portals_with_multiple_mcds !== undefined && data.portals_with_multiple_mcds !== null ? data.portals_with_multiple_mcds.toLocaleString() : 'N/A';
            const totalMCDsAllSafe = data.total_mcds_all !== undefined && data.total_mcds_all !== null ? data.total_mcds_all.toLocaleString() : 'N/A';
            const pricingCountSafe = data.pricing_count !== undefined && data.pricing_count !== null ? data.pricing_count.toLocaleString() : 'N/A';
            const seatChangeCountSafe = data.seat_change_count !== undefined && data.seat_change_count !== null ? data.seat_change_count.toLocaleString() : 'N/A';
            const contactDowngradeCountSafe = data.contact_downgrade_count !== undefined && data.contact_downgrade_count !== null ? data.contact_downgrade_count.toLocaleString() : 'N/A';


            return `
                <div id="${data.date_id}" class="page-content hidden space-y-8">
                    <h2 class="text-3xl font-bold text-stone-800 mb-4">${data.month_label} Detail Analysis</h2>
                    
                    <!-- Removed AI Narrative Section -->


                    <section>
                        <h3 class="text-2xl font-semibold text-stone-800 mb-4">1. Credit Usage Analysis (The Risk)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-6">
                            <!-- Total Credit MCDs -->
                            <div class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                                <h4 class="text-sm font-medium text-stone-500 uppercase tracking-wide">Total Credit-Related MCDs</h4>
                                <p class="mt-2 text-4xl font-bold text-amber-600">${totalMCDsCreditSafe}</p>
                                <p class="mt-1 text-sm text-stone-600">(${data.total_mcds_credit_perc}% of all MCDs)</p>
                            </div>
                            <!-- Accidental Overage -->
                            <div class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                                <h4 class="text-sm font-medium text-stone-500 uppercase tracking-wide">Accidental Credit Overage</h4>
                                <p class="mt-2 text-4xl font-bold text-blue-600">${accidentalCountSafe}</p>
                                <p class="mt-1 text-sm text-stone-600">(${data.accidental_perc}% of Credit MCDs)</p>
                            </div>
                            <!-- Estimated Refund Risk -->
                            <div class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                                <h4 class="text-sm font-medium text-stone-500 uppercase tracking-wide">Estimated Refund Risk (MRR)</h4>
                                <p class="mt-2 text-4xl font-bold text-red-600">${formatCurrency(data.risk_refund_amount)}</p>
                                <p class="mt-1 text-sm text-stone-600">(${data.refund_perc}% explicit refund requests)</p>
                            </div>
                             <!-- Portals with Credit MCDs (from Section 4) -->
                            <div class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                                <h4 class="text-sm font-medium text-stone-500 uppercase tracking-wide">Portals with Credit MCDs</h4>
                                <p class="mt-2 text-4xl font-bold text-stone-800">${portalsCreditSafe}</p>
                                <p class="mt-1 text-sm text-stone-600">Unique portals in discussion</p>
                            </div>
                        </div>
                    </section>
                    
                    <section>
                        <h3 class="text-2xl font-semibold text-stone-800 mb-4">2. Customer Sentiment & Action Themes</h3>
                        <p class="text-base text-stone-700 mb-4">
                            The chart visualizes the dominant friction points (Pricing, Accidental) and the resulting core service contraction actions (Seat, Contact Downgrade) taken by customers.
                        </p>
                        <div class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                            <div class="chart-container">
                                <canvas id="sentimentChart-${data.date_id}"></canvas>
                            </div>
                            <div class="mt-6 overflow-x-auto">
                                <h4 class="text-lg font-semibold text-stone-800 mb-2">Sentiment & Action Data Table</h4>
                                <table class="min-w-full divide-y divide-stone-200 data-table">
                                    <thead class="bg-stone-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Theme Category</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Theme</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Count</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">% of Credit MCDs</th>
                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone-500 uppercase tracking-wider">Source Tag(s)</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-stone-200">
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-700">Primary Friction</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-red-700">Pricing Model Concerns</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${pricingCountSafe}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${data.pricing_perc}%</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500 font-mono"><code>Financial Constraints</code></td>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-amber-700">Secondary Action</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-amber-700">Seat Change (Contraction)</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${seatChangeCountSafe}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${data.seat_change_perc}%</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500 font-mono"><code>Seat Change</code></td>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-700">Secondary Action</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-green-700">Contact Downgrade (Contraction)</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${contactDowngradeCountSafe}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${data.contact_downgrade_perc}%</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500 font-mono"><code>Contact Downgrade</code></td>
                                        </tr>
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-700">Primary Friction</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-700">Accidental Upgrade/Overage Friction</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${accidentalCountSafe}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-900">${data.accidental_perc}%</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500 font-mono"><code>Accidental Purchase/Upgrade</code></td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-2xl font-semibold text-stone-800 mb-4">3. Top Non-Credit MCD Categories (The Baseline)</h3>
                        <p class="text-base text-stone-700 mb-4">
                            These categories show the high-volume, "normal" MCD topics for context. The count represents the total frequency of the tag's appearance across all non-credit, non-financial records.
                        </p>
                        <div class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                            <div class="chart-container-horizontal">
                                <canvas id="nonCreditChart-${data.date_id}"></canvas>
                            </div>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-2xl font-semibold text-stone-800 mb-4">4. Portal Activity (The "Who")</h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                                <h4 class="text-sm font-medium text-stone-500 uppercase tracking-wide">Total Unique Portals (All MCDs)</h4>
                                <p class="mt-2 text-4xl font-bold text-stone-800">${uniquePortalsAllSafe}</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                                <h4 class="text-sm font-medium text-stone-500 uppercase tracking-wide">Portals with Multiple MCDs</h4>
                                <p class="mt-2 text-4xl font-bold text-stone-800">${portalsMultipleSafe}</p>
                            </div>
                            <div class="bg-white p-6 rounded-lg shadow-md border border-stone-200">
                                <h4 class="text-sm font-medium text-stone-500 uppercase tracking-wide">Total MCDs (All Categories)</h4>
                                <p class="mt-2 text-4xl font-bold text-stone-800">${totalMCDsAllSafe}</p>
                            </div>
                        </div>
                    </section>
                </div>
            `;
        }
        
        function createSummaryRows(data) {
            const tbody = document.getElementById('summary-tbody');
            if (!tbody) return;
            
            const monthLabels = data.map(d => d.month_label.split(' ')[0]);

            // Definition of metrics to display
            const metrics = [
                {
                    label: 'Total MCDs (Credit-Related)', 
                    key_count: 'total_mcds_credit', 
                    key_perc: 'total_mcds_credit_perc',
                    isCurrency: false, 
                    isPercent: true, 
                    isTotalAvg: true,
                    key_trend: 'total_mcds_credit',
                    trend_type: 'count',
                },
                {
                    label: 'Refund Risk (MRR Exposed)', 
                    key_count: 'risk_refund_amount', 
                    key_perc: null, 
                    isCurrency: true, 
                    isPercent: false, 
                    isTotalAvg: true,
                    key_trend: 'risk_refund_amount',
                    trend_type: 'currency',
                },
                // NEW ROW: Explicit Refund Requests
                {
                    label: 'Explicit Refund Requests (Count)', 
                    key_count: 'refund_count', 
                    key_perc: 'refund_perc', 
                    isCurrency: false, 
                    isPercent: true,
                    isTotalAvg: false,
                    key_trend: 'refund_count',
                    trend_type: 'count',
                },
                {
                    label: '--- PRIMARY FRICTION ---', 
                    isSeparator: true
                },
                {
                    label: 'Pricing Model Concerns (Financial)', 
                    key_count: 'pricing_count', 
                    key_perc: 'pricing_perc', 
                    isCurrency: false, 
                    isPercent: true,
                    isTotalAvg: false,
                    key_trend: 'pricing_perc',
                    trend_type: 'perc',
                },
                {
                    label: 'Accidental Overage Friction (UI/Policy)', 
                    key_count: 'accidental_count', 
                    key_perc: 'accidental_perc', 
                    isCurrency: false, 
                    isPercent: true,
                    isTotalAvg: false,
                    key_trend: 'accidental_perc',
                    trend_type: 'perc',
                },
                {
                    label: '--- SECONDARY ACTION ---', 
                    isSeparator: true
                },
                {
                    label: 'Seat Change (Core Contraction)', 
                    key_count: 'seat_change_count', 
                    key_perc: 'seat_change_perc', 
                    isCurrency: false, 
                    isPercent: true,
                    isTotalAvg: false,
                    key_trend: 'seat_change_perc',
                    trend_type: 'perc',
                },
                {
                    label: 'Contact Downgrade (Core Contraction)', 
                    key_count: 'contact_downgrade_count', 
                    key_perc: 'contact_downgrade_perc', 
                    isCurrency: false, 
                    isPercent: true,
                    isTotalAvg: false,
                    key_trend: 'contact_downgrade_perc',
                    trend_type: 'perc',
                },
                {
                    label: '--- PORTAL ACTIVITY ---', 
                    isSeparator: true
                },
                {
                    label: 'Portals with Credit MCDs', 
                    key_count: 'portals_with_credit_mcds', 
                    key_perc: null, 
                    isCurrency: false, 
                    isPercent: false,
                    isTotalAvg: false, 
                    key_trend: 'portals_with_credit_mcds',
                    trend_type: 'count',
                },
                {
                    label: 'Portals with Multiple MCDs', 
                    key_count: 'portals_with_multiple_mcds', 
                    key_perc: null, 
                    isCurrency: false, 
                    isPercent: false,
                    isTotalAvg: false,
                    key_trend: 'portals_with_multiple_mcds',
                    trend_type: 'count',
                }
            ];

            let html = '';
            
            metrics.forEach((metric, index) => {
                if (metric.isSeparator) {
                    // Adjusted colspan to match the total number of columns (1 label + N months + 1 trend = N + 2)
                    html += `<tr class="bg-stone-200"><td colspan="${data.length + 2}" class="text-sm font-semibold text-stone-700 py-2 px-6">${metric.label}</td></tr>`;
                    return;
                }

                const trendId = `sparkline-${index}`;

                let rowData = data.map(d => {
                    const count = d[metric.key_count] !== undefined && d[metric.key_count] !== null ? d[metric.key_count] : 0;
                    
                    // Ensure percentage defaults to 0 if the key is present but the value is undefined/null
                    let perc = 'N/A';
                    if (metric.key_perc) { 
                        perc = d[metric.key_perc] !== undefined && d[metric.key_perc] !== null ? d[metric.key_perc] : 0;
                    }
                    
                    if (metric.isCurrency) {
                        return `<td class="text-sm text-stone-900">${formatCurrency(count)}</td>`;
                    }
                    if (metric.isPercent) {
                        const countDisplay = count.toLocaleString();
                        return `<td class="text-sm text-stone-900">${countDisplay} <span class="text-xs text-stone-500">(${perc}%)</span></td>`;
                    }
                    // Default: Simple Count
                    return `<td class="text-sm text-stone-900">${count.toLocaleString()}</td>`;
                }).join('');

                // Get the data array for the sparkline trend
                const trendData = data.map(d => d[metric.key_trend]);
                
                // Final trend column (Sparkline)
                const totalCell = `
                    <td class="bg-stone-100 text-center sparkline-cell">
                        <canvas id="${trendId}"></canvas>
                    </td>
                `;


                html += `
                    <tr>
                        <td class="text-sm font-medium text-stone-800">${metric.label}</td>
                        ${rowData}
                        ${totalCell}
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            
            // Render Sparklines AFTER DOM update
            metrics.forEach((metric, index) => {
                if (!metric.isSeparator) {
                    const trendId = `sparkline-${index}`;
                    const trendData = data.map(d => d[metric.key_trend]);
                    const monthLabelsShort = data.map(d => d.month_label.substring(0, 3));
                    renderSparkline(trendId, trendData, monthLabelsShort, metric.trend_type);
                }
            });
        }
        
        function renderSparkline(canvasId, data, labels, trendType) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            const chartInstances = Chart.getChart(ctx);
            if (chartInstances) {
                chartInstances.destroy();
            }

            const isCurrency = trendType === 'currency';
            const isPercent = trendType === 'perc';
            
            // Determine line color based on trend type (e.g., red for risk/high perc, blue for neutral count)
            let lineColor;
            if (isCurrency || isPercent) {
                // If high value is bad (risk/high friction), use red/amber.
                lineColor = isCurrency ? '#dc2626' : '#f59e0b';
            } else {
                lineColor = '#3b82f6';
            }
            
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        borderColor: lineColor,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointBackgroundColor: lineColor,
                        fill: false,
                        tension: 0.2 // Soft curves
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            bodyFont: { size: 10 },
                            callbacks: {
                                label: function(context) {
                                    let value = context.parsed.y;
                                    if (isCurrency) return formatCurrency(value);
                                    if (isPercent) return value + '%';
                                    return formatNumber(value);
                                },
                                title: function(context) {
                                    return context[0].label;
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 0
                    },
                    scales: {
                        x: { display: false },
                        y: { 
                            display: false,
                            beginAtZero: true,
                            // Ensure the scale is tight around the data
                            min: Math.min(...data.filter(v => v !== null)) * 0.95,
                            max: Math.max(...data.filter(v => v !== null)) * 1.05
                        }
                    }
                }
            });
        }

        // --- CHART RENDERING (Monthly Detail Charts remain unchanged) ---

        function renderChart(data, chartType) {
            const chartId = chartType === 'sentiment' ? `sentimentChart-${data.date_id}` : `nonCreditChart-${data.date_id}`;
            const ctx = document.getElementById(chartId);
            if (!ctx) return;

            // Destroy existing chart if it exists
            const chartInstances = Chart.getChart(ctx);
            if (chartInstances) {
                chartInstances.destroy();
            }

            let chartData, options, type, labels;
            
            if (chartType === 'sentiment') {
                labels = ['Pricing Model Concerns', 'Seat Change (Contraction)', 'Contact Downgrade (Contraction)', 'Accidental Overage Friction'];
                chartData = [data.pricing_perc, data.seat_change_perc, data.contact_downgrade_perc, data.accidental_perc];
                const backgroundColors = ['#dc2626', '#fbbf24', '#22c55e', '#3b82f6'];
                type = 'bar';
                options = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw}%` } }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 40,
                            grid: { color: '#e7e5e4' },
                            ticks: { color: '#57534e', callback: (v) => v + '%' }
                        },
                        x: { grid: { display: false }, ticks: { color: '#57534e' } }
                    },
                    datasets: [{
                        label: '% of Credit MCDs',
                        data: chartData,
                        backgroundColor: backgroundColors,
                        borderRadius: 4,
                        borderWidth: 0
                    }]
                };

            } else if (chartType === 'non-credit') {
                labels = data.non_credit_categories.map(c => c.category);
                chartData = data.non_credit_categories.map(c => c.count);
                const backgroundColors = ['#6b7280', '#71717a', '#a8a29e'];
                type = 'bar';
                options = {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { callbacks: { label: (c) => `${c.label}: ${c.raw.toLocaleString()}` } }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: '#e7e5e4' },
                            ticks: { color: '#57534e' }
                        },
                        y: { grid: { display: false }, ticks: { color: '#57534e' } }
                    },
                    datasets: [{
                        label: 'Count of MCDs',
                        data: chartData,
                        backgroundColor: backgroundColors,
                        borderRadius: 4,
                        borderWidth: 0
                    }]
                };
            }

            new Chart(ctx, { type, data: { labels, datasets: options.datasets }, options });
        }


        // --- 3. DATA PROCESSING LOGIC (Copied from Python Analysis) ---
        
        // FIX: Robust CSV parser to handle commas within quoted fields
        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return null;

            // Simple robust field splitting based on quotation marks
            const splitLine = (line) => {
                const results = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        results.push(current.trim().replace(/^"|"$/g, '').trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                results.push(current.trim().replace(/^"|"$/g, '').trim());
                return results;
            };

            const headerRow = splitLine(lines[0]);
            
            // Identify critical column indices
            // FIX: Ensure header is trimmed before matching to improve resilience
            const getIndex = (name) => headerRow.findIndex(h => h.toLowerCase().trim().includes(name));
            
            const monthIndex = getIndex('interaction month');
            const portalIdIndex = getIndex('portal id');
            const tagsIndex = getIndex('mcd tags');
            const mrrBomIndex = getIndex('total net mrr bom');
            const mrrEomIndex = getIndex('total net mrr eom');

            if (monthIndex === -1 || tagsIndex === -1 || mrrBomIndex === -1 || mrrEomIndex === -1) {
                // If critical columns are missing, return null to signal error
                return null;
            }
            
            const rawData = [];
            for (let i = 1; i < lines.length; i++) {
                const values = splitLine(lines[i]);
                if (values.length < tagsIndex || values[tagsIndex].trim() === '') continue;
                
                const cleanMRR = (val) => {
                    const cleanVal = val.replace(/[\s$,]/g, '');
                    return parseFloat(cleanVal) || 0;
                };

                const mrrBom = cleanMRR(values[mrrBomIndex]);
                const mrrEom = cleanMRR(values[mrrEomIndex]);
                
                rawData.push({
                    month: values[monthIndex].substring(0, 7), // YYYY-MM format
                    portalId: values[portalIdIndex] ? values[portalIdIndex].replace(/\.0$/, '') : '',
                    // Tags are split by COMMA (,) and normalized to lowercase and trimmed strictly for reliable matching.
                    tags: values[tagsIndex].split(',').map(t => t.trim().toLowerCase()).filter(t => t.length > 0), 
                    mrrBom: mrrBom,
                    mrrEom: mrrEom,
                    mrrChange: mrrBom - mrrEom
                });
            }
            return rawData;
        }
        
        function parseAndCalculateMetrics(csvText) {
            const rawData = parseCSV(csvText);
            
            if (rawData === null) {
                return null;
            }
            if (rawData.length === 0) {
                return [];
            }

            // --- CONSTANTS (All lowercase for consistent comparison with normalized data) ---
            const refundTags = ['refund', 'refund/credit indicators', 'refund/credit request'];
            const creditTag = 'hubspot credits';
            const accidentalTag = 'accidental purchase/upgrade';
            const pricingTag = 'financial constraints';
            const seatTag = 'seat change';
            const contactTag = 'contact downgrade';

            // Group by month and calculate metrics
            const monthlyData = {};
            rawData.forEach(row => {
                if (!monthlyData[row.month]) {
                    monthlyData[row.month] = {
                        rows: [],
                        portalIds: new Set(),
                        portalMcdCounts: {}
                    };
                }
                monthlyData[row.month].rows.push(row);
                monthlyData[row.month].portalIds.add(row.portalId);
                
                monthlyData[row.month].portalMcdCounts[row.portalId] = (monthlyData[row.month].portalMcdCounts[row.portalId] || 0) + 1;
            });
            
            const results = [];
            // Sort by month (YYYY-MM)
            const sortedMonths = Object.keys(monthlyData).sort();

            sortedMonths.forEach(month_date => {
                const monthData = monthlyData[month_date];
                const dfMonth = monthData.rows;
                
                // FIX: Force date parsing to UTC to prevent local time zone shift
                const dtObj = new Date(month_date + '-01T00:00:00Z'); 
                
                // Get month label using UTC methods for consistency
                const monthLabel = dtObj.toLocaleString('en-US', { month: 'long', year: 'numeric', timeZone: 'UTC' });
                const dateId = dtObj.toLocaleString('en-US', { month: 'short', year: 'numeric', timeZone: 'UTC' }).toLowerCase().replace(' ', '-');

                // Total MCDs
                const totalMCDsAll = dfMonth.length;
                
                // --- CREDIT SCOPE ---
                const dfCredit = dfMonth.filter(r => r.tags.includes(creditTag));
                const totalMCDsCredit = dfCredit.length;
                const totalMCDsCreditPerc = totalMCDsAll > 0 ? parseFloat((totalMCDsCredit / totalMCDsAll * 100).toFixed(1)) : 0;

                // Accidental (Credit Overage Only)
                const accidentalCount = dfCredit.filter(r => r.tags.includes(accidentalTag)).length;
                const accidentalPerc = totalMCDsCredit > 0 ? parseFloat((accidentalCount / totalMCDsCredit * 100).toFixed(1)) : 0;

                // Explicit Refund
                const refundCount = dfCredit.filter(r => r.tags.some(tag => refundTags.includes(tag))).length;
                const refundPerc = totalMCDsCredit > 0 ? parseFloat((refundCount / totalMCDsCredit * 100).toFixed(1)) : 0;

                // Estimated Refund Risk
                const estimatedRefundRisk = dfCredit.filter(r => r.mrrChange > 0).reduce((sum, r) => sum + r.mrrChange, 0);

                // --- SENTIMENT & ACTION ---
                const getSentimentCount = (tag) => dfCredit.filter(r => r.tags.includes(tag)).length;
                
                const pricingCount = getSentimentCount(pricingTag);
                const seatChangeCount = getSentimentCount(seatTag);
                const contactDowngradeCount = getSentimentCount(contactTag);
                
                const pricingPerc = totalMCDsCredit > 0 ? parseFloat((pricingCount / totalMCDsCredit * 100).toFixed(1)) : 0;
                const seatChangePerc = totalMCDsCredit > 0 ? parseFloat((seatChangeCount / totalMCDsCredit * 100).toFixed(1)) : 0;
                const contactDowngradePerc = totalMCDsCredit > 0 ? parseFloat((contactDowngradeCount / totalMCDsCredit * 100).toFixed(1)) : 0;
                
                // --- NON-CREDIT BASELINE ---
                const allCrTags = [creditTag, ...refundTags, pricingTag, accidentalTag, seatTag, contactTag];
                const dfNonCredit = dfMonth.filter(r => !r.tags.some(tag => allCrTags.includes(tag)));
                const totalNonCreditMCDs = dfNonCredit.length;
                
                const nonCreditTagCounts = {};
                dfNonCredit.forEach(r => r.tags.forEach(tag => {
                    if (tag.length > 0) {
                        nonCreditTagCounts[tag] = (nonCreditTagCounts[tag] || 0) + 1;
                    }
                }));

                const sortedNonCreditTags = Object.entries(nonCreditTagCounts)
                    .sort(([, countA], [, countB]) => countB - countA)
                    .slice(0, 3);
                
                const nonCreditCategories = sortedNonCreditTags.map(([tag, count]) => ({
                    category: tag,
                    count: count,
                    perc: totalNonCreditMCDs > 0 ? parseFloat((count / totalNonCreditMCDs * 100).toFixed(1)) : 0
                }));

                // --- PORTAL COUNTS ---
                const totalUniquePortals = monthData.portalIds.size;
                const portalsWithCreditMcds = dfCredit.map(r => r.portalId).filter((v, i, a) => a.indexOf(v) === i).length;
                const portalsWithMultipleMcds = Object.values(monthData.portalMcdCounts).filter(count => count > 1).length;

                // --- Compile Monthly Data ---
                results.push({
                    month_label: monthLabel, date_id: dateId,
                    total_mcds_all: totalMCDsAll, total_mcds_credit: totalMCDsCredit, total_mcds_credit_perc: totalMCDsCreditPerc,
                    risk_refund_amount: parseFloat(estimatedRefundRisk.toFixed(2)), accidental_count: accidentalCount, accidental_perc: accidentalPerc,
                    refund_count: refundCount, refund_perc: refundPerc, pricing_count: pricingCount, pricing_perc: pricingPerc,
                    seat_change_count: seatChangeCount, seat_change_perc: seatChangePerc, contact_downgrade_count: contactDowngradeCount, contact_downgrade_perc: contactDowngradePerc,
                    unique_portals_all: totalUniquePortals, portals_with_credit_mcds: portalsWithCreditMcds, portals_with_multiple_mcds: portalsWithMultipleMcds,
                    non_credit_categories: nonCreditCategories
                });
            });
            
            // Only keep the last 6 months
            return results.slice(-6);
        }

        // --- 4. RENDER AND NAVIGATION LOGIC ---

        function renderAllContent() {
            const contentContainer = document.getElementById('content-container');
            
            // 1. Create Navigation Buttons (must be done before content is rendered)
            // Note: createNavButtons calls setupNavigation internally and will return early if no data.
            createNavButtons();

            // 2. Render all content pages
            let allPagesHtml = '';
            
            // The Summary page (which contains the upload form) is always the first template rendered.
            allPagesHtml += getSummaryTemplate(ALL_MCD_DATA); 
            
            // Only render detail and index pages if data is present
            if (ALL_MCD_DATA.length > 0) {
                // Monthly Detail Pages (must come before Index)
                ALL_MCD_DATA.forEach(data => {
                    allPagesHtml += getMonthlyDetailTemplate(data);
                });
                
                // Index / Assumptions Page (LAST)
                allPagesHtml += getIndexTemplate(); 
            }
            
            contentContainer.innerHTML = allPagesHtml;
            
            // 3. Set initial state (Summary tab active, others hidden)
            updateHeaderDates();
            
            // The default tab is always 'summary' (which contains the initial upload form).
            const defaultTabId = 'summary';

            // Hide all pages initially, then show the default one
            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
            const defaultPage = document.getElementById(defaultTabId);
            if (defaultPage) {
                defaultPage.classList.remove('hidden');
            }
            
            // Activate the corresponding button
            const defaultNavButton = document.querySelector(`.nav-button[data-tab="${defaultTabId}"]`);
            if (defaultNavButton) {
                defaultNavButton.classList.add('active');
            }
            
            // 4. Setup listeners and charts
            setupFileListeners(); 
        }

        function initializeCharts() {
            if (ALL_MCD_DATA.length === 0) return;

            // Render charts for all months 
            ALL_MCD_DATA.forEach(data => {
                renderChart(data, 'sentiment');
                renderChart(data, 'non-credit');
            });

            // Initialize summary table and sparklines
            createSummaryRows(ALL_MCD_DATA); 
        }

        function setupNavigation() {
            const tabs = document.querySelectorAll('.nav-button');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.dataset.tab;
                    const contentPages = document.querySelectorAll('.page-content');

                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    contentPages.forEach(page => {
                        if (page.id === tabId) {
                            page.classList.remove('hidden');
                        } else {
                            page.classList.add('hidden');
                        }
                    });
                });
            });
        }

        function setupFileListeners() {
            // Elements are selected INSIDE this function, after content is rendered
            const fileInput = document.getElementById('csv-file-input');
            const refreshButton = document.getElementById('refresh-dashboard');
            const statusElement = document.getElementById('upload-status');
            
            if (!fileInput || !refreshButton) {
                return;
            }

            fileInput.addEventListener('change', () => {
                if (fileInput.files.length > 0) {
                    refreshButton.disabled = false;
                    statusElement.textContent = `File selected: ${fileInput.files[0].name}. Click 'Process & Refresh' to load.`;
                    statusElement.classList.remove('text-red-500', 'text-green-600');
                    statusElement.classList.add('text-stone-700');
                } else {
                    refreshButton.disabled = true;
                    statusElement.textContent = '';
                }
            });

            refreshButton.addEventListener('click', () => {
                const file = fileInput.files[0];
                if (!file) {
                    statusElement.textContent = 'Please select a file first.';
                    statusElement.classList.add('text-red-500');
                    return;
                }
                
                statusElement.textContent = 'Processing data...';
                statusElement.classList.remove('text-red-500', 'text-green-600');
                statusElement.classList.add('text-amber-600');
                refreshButton.disabled = true;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const newMcdData = parseAndCalculateMetrics(e.target.result);
                        if (newMcdData === null) {
                             statusElement.textContent = 'Processing error: Missing required column headers (Interaction Month, MCD Tags, Total Net MRR BOM/EOM). Check Index/Assumptions tab.';
                            statusElement.classList.remove('text-amber-600');
                            statusElement.classList.add('text-red-500');
                            return;
                        }
                        
                        if (newMcdData.length > 0) {
                            ALL_MCD_DATA = newMcdData;
                            // Rerender all content with new data, which re-creates nav buttons and file listeners
                            renderAllContent(); 
                            initializeCharts(); // Reruns chart and summary table logic
                            
                            // Set the Summary as the active tab after a successful load
                            document.querySelectorAll('.page-content').forEach(page => page.classList.add('hidden'));
                            document.getElementById('summary').classList.remove('hidden');
                            document.querySelector('.nav-button[data-tab="summary"]').classList.add('active');


                            statusElement.textContent = `Successfully loaded ${ALL_MCD_DATA.length} months of data.`;
                            statusElement.classList.remove('text-amber-600', 'text-red-500');
                            statusElement.classList.add('text-green-600');
                        } else {
                            statusElement.textContent = 'Loaded file but found no valid data rows to process.';
                            statusElement.classList.remove('text-amber-600');
                            statusElement.classList.add('text-red-500');
                        }
                    } catch (error) {
                        statusElement.textContent = `Processing error: ${error.message}`;
                        statusElement.classList.remove('text-amber-600');
                        statusElement.classList.add('text-red-500');
                    } finally {
                        refreshButton.disabled = false;
                    }
                };
                reader.readAsText(file);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderAllContent(); 
        });
    </script>

</body>
</html>